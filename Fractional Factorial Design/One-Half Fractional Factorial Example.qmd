---
title: "A $2^{4-1}$ One-Half Fractional Factorial Design Example"
author: "Dr Austin R Brown"
format:
  pdf:
    include-in-header:
      - text: |
          \usepackage{tabularx}
          \usepackage{booktabs}
editor: visual
execute:
  echo: true
  include: true
  warning: false
  message: false
---

## Introduction

Exercise Science Researchers are investigating how different training strategies affect muscle endurance in recreationally active adults. They are particularly interested in four binary (two-level) factors that are commonly adjusted in resistance training programs:

\vskip 0.25 in

| Factor                    | Levels                              |
|---------------------------|--------------------------------------|
| **A. Training Frequency** | Low (2x/week) vs. High (4x/week)     |
| **B. Repetition Range**   | Low (6–8 reps) vs. High (12–15 reps) |
| **C. Rest Interval**      | Long (2 minutes) vs. Short (30 sec)  |
| **D. Exercise Order**     | Large-to-small vs. Small-to-large    |

\vskip 0.25 in

The response variable is **muscle endurance**, measured as the number of repetitions completed at a fixed submaximal load after 6 weeks of training. They choose a one-half fractional factorial design with a **defining relation** of $I=ABCD$ (e.g., $D=ABC$.)

\vskip 0.15 in

This means: \
    - The **Exercise Order** factor (D) is aliased with the three-way interaction of A, B, and C. \
    - The **Training Frequency** factor (A) is aliased with the three-way interaction of B, C, and D. \
    - The **Repetition Range** factor (B) is aliased with the three-way interaction of A, C, and D. \
    - The **Rest Interval** factor (C) is aliased with the three-way interaction of A, B, and D. \
    - Note, what I just did in the above bullet points, where I specified what interaction effects the main effects are aliased with, is called **defining the aliasing structure** and is something you will be asked to do on a future assignment. \
    - This design is of resolution IV, meaning that main effects are not confounded with two-way interactions, but two-way interactions may be confounded with other two-way interactions or three-way interactions.

\vskip 0.15 in

Our data are contained in the `Muscle Endurance Example.xlsx` file. With these data, let's:

\vskip 0.25 in

1. Build the +/- table:

\vskip 0.15 in

To do this with the `FrF2` function within the package of the same name, we need to specify a few things. _First_, the number of runs is $2^{4-1} = 8$. _Second_, we need to specify the number of factors, which is 4. _Third_ and finally, we need to specify the defining relation, which is `I=ABCD` (i.e., $D=ABC$).

```{r}
library(tidyverse)
library(readxl)
library(rstatix)
library(FrF2)
## Let's build the +/- table using the FrF2 package ##
design <- FrF2(8, #number of runs
               4, #number of factors
               generators="ABC", #defining relation,
               randomize = F)
print(design)
```

Let's beautify and clarify this just a bit with some code!

```{r}
## We will coerce to a tibble and then add the effect column
## like we did in the lecture notes: ##
library(knitr)
design <- design |>
  as_tibble() |>
  mutate(Effect = c("(1)","ad","bd","ab","cd",
                    "ac","bc","abcd"))
kable(design)
```

To remember which row combinations yield which effects, remember that all - (or -1 in this case) are for the (1) effect. All + (or +1 in this case) are for the highest-order interaction (abcd in this case). All others are mixed. For example, the ad effect is high (+) on A and D and low (-) on B and C. All other cases follow the same logic.

\vskip 0.25 in

2. Read in the data and perform exploratory analysis.

```{r}
## Read in the Data ##
muscle <- read_excel("Muscle Endurance Example.xlsx")
muscle |>
  glimpse()
## Calculate Means and Standard Deviations
## but group in one kable ##
## First, transposing all from wide to long ##
library(tidyr)
muscle_long <- muscle |>
  pivot_longer(cols = c(TrainingFrequency, RepetitionRange,
                        RestInterval, ExerciseOrder),
               names_to = "Effect",
               values_to = "Level") |>
  group_by(Effect, Level) |>
  summarise(mean = mean(MuscleEndurance),
            sd = sd(MuscleEndurance)) |>
  ungroup() |>
  mutate(Effect_Letter = case_when(
    
    Effect == "TrainingFrequency" ~ "A",
    Effect == "RepetitionRange" ~ "B",
    Effect == "RestInterval" ~ "C",
    Effect == "ExerciseOrder" ~ "D"
    
  )) |>
  arrange(Effect_Letter)
## Now, put into a kable :) ##
kable(muscle_long)
```

Within each main effect, we can see differences between the levels. The greatest differences seem to be in effects A and B with C and D being less pronounced.

\vskip 0.15 in

3. Build ANOVA model and check assumptions

\vskip 0.15 in



```{r}
mod <- aov(MuscleEndurance ~ TrainingFrequency * RepetitionRange *
               RestInterval * ExerciseOrder,
             data = muscle)
## Normality ##
library(broom)
muscle |>
  ggplot(aes(sample=residuals(mod))) +
  geom_qq() +
  geom_qq_line() +
  theme_classic()
mod |>
  resid() |>
  shapiro.test() |>
  tidy()
```

The normality assumption seems reasonably met give the non-significant p-value from the Shapiro-Wilk test and the generally linear pattern of the QQ plot. Let's move onto constant variance!

```{r}
## Constant Variance ##
muscle |>
  ggplot(aes(x=fitted(mod),y=rstandard(mod))) +
  geom_point() +
  geom_hline(yintercept=0,linetype='dashed') +
  geom_hline(yintercept=3,color='blue') +
  geom_hline(yintercept=-3,color='blue') +
  theme_classic()
library(lmtest)
mod |>
  bptest() |>
  tidy()
```


Here again, the scatterplot of the standardized residuals against the fitted values shows no clear pattern with the points randomly deviating about 0. The Breusch-Pagan test is also non-significant, indicating that we do not have a problem with constant variance. So let's move to the results!!

```{r}
mod |>
  tidy() |>
  mutate(sig = if_else(p.value < 0.05,"Yes","No"))
```

Here we can see that the differences we observed between the + and - levels of Training Frequency, Repetition Range, and Rest Interval were statistically meaningful. Exercise Order nor any of our two-way interactions were statistically meaningful. However, remember, we are using a one-half fractional factorial design, so we need to be careful about interpreting these results considering the aliasing structure we specified previously.

\vskip 0.25 in

Now, let's estimate the main effects and calculate the partial $\eta^2$ values.

```{r}
## Estimate Main Effects as before ##
library(tidyr)
muscle |>
  mutate(Effect = rep(c("(1)","ad","bd","ab","cd",
                        "ac","bc","abcd"),each=3)) |>
  group_by(Effect) |>
  summarise(mean = mean(MuscleEndurance)) |>
  ungroup() |>
  pivot_wider(names_from = Effect,
              values_from = mean) |>
  mutate(A = 0.25*(-`(1)` + ad - bd + ab - cd + ac - bc + abcd),
         B = 0.25*(-`(1)` - ad + bd + ab - cd - ac + bc + abcd),
         C = 0.25*(-`(1)` - ad - bd - ab + cd + ac + bc + abcd),
         D = 0.25*(-`(1)` + ad + bd - ab + cd - ac - bc + abcd),
         .keep='unused')

```

Just like in the other example, these differences are simply the mean difference between the + and - levels of each factor. These tell us, contextually, how muscle endurance is expected to change, on average, moving from the - level to the + level. We have to remember that these main effects are aliased with the three-way interactions specified previously. But, if we assume that the three-way interactions are not significant, we can safely interpret these main effects on their own without worrying about needing to perform a fold-over design.

```{r}
## Partial Eta Squared ##
options(scipen=999)
mod |>
  partial_eta_squared()
```

As we can see here, the partial $\eta^2$ values for the main effects would all be considered large (> 0.14) and the two-way interactions would be considered small (< 0.01). This is consistent with what we saw in the ANOVA table above. The partial $\eta^2$ values for the main effects are all large (> 0.14) and the two-way interactions are all small with the possible of exception of Training Frequency and Rest Interval approaching the medium threshold. This is consistent with what we saw in the ANOVA table. 

\vskip 0.15 in

Remember, partial $\eta^2$ values are interpreted as the proportion of variance in the dependent variable (muscle endurance) that is explained by the independent variable. The larger the partial $\eta^2$ value, the more variance in the dependent variable is explained by the independent variable.

\vskip 0.15 in

So finally, contextually, what does this all suggest? All of the + levels of the main effects are associated with greater muscle endurance with Training Frequency and Repetition Range being most important.