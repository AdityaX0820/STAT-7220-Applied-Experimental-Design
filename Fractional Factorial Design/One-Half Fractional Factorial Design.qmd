---
title: "Introduction to Fractional $2^k$ Designs"
author: "Dr Austin R Brown"
institute: "Kennesaw State University"
format:
  beamer:
    include-in-header:
      - text: |
          \usepackage{tabularx}
          \usepackage{booktabs}
editor: visual
execute:
  echo: true
  include: true
  warning: false
  message: false
---

## Introduction

-   Remember from our prior lessons that one of the advantages of $2^k$ designs is that they are very efficient in terms of the number of runs required to estimate the effects of $k$ factors.
    -   We group the levels of the factors into two levels, $-$ and $+$, and then run the experiment at all combinations of these levels.

\vskip 0.15 in

-   However, even for a reasonably small value of $k$, the number of required runs can become prohibitively large.
    -   For example, if $k = 6$, then the number of runs required is $2^{6} = 64$.

\vskip 0.15 in

-   What do we mean by this exactly and why is it a problem? Let's dive deeper.

## Introduction

-   Suppose we have a $2^6$ design. What this means is that we have 6 main effects, but we also have all of the two, three, four, five, and six way interactions.

\vskip 0.15 in

-   The formula for the fully crossed design is so large, I'm not going to include it here. But as you can imagine, we have six main effects, 15 two-way interactions, 20 three-way interactions, 15 four-way interactions, 6 five-way interactions, and one six-way interaction.

## Introduction

-   To estimate all of these effects, we have to have 64 runs (or observations).

\vskip 0.15 in

-   Recall from regression, if we have $n$ observations, at most, we can estimate $p=n$ parameters. The number of parameters is equal to the number of main effects plus the number of interactions and the overall mean.

\vskip 0.15 in

-   So in this case, we have 64 observations and 64 parameters. This means that we are estimating one parameter per observation.
    -   This is not a good design. We are not estimating the parameters well, and we are not estimating the interactions well. This is a problem because we are not getting enough information from our design to make good conclusions about the effects of our factors on the response variable.

## Introduction

-   Additionally, it is highly unlikely that any interaction terms beyond the two-way interactions are important practically or statistically.
    -   So, even if we did have more than one replicate per parameter, we probably don't care too much about the three-way, four-way, five-way, and six-way interactions.

\vskip 0.15 in

-   If this is the case, then we can save a lot of time (and potentially money) by not running the full $2^k$ design.
    -   Instead, we can run a fractional factorial design, which is a subset of the full factorial design.

\vskip 0.15 in

-   In such a design, we expect that information on the main effects and low-order interactions can be obtained from this smaller number of runs (observations).

## Introduction

-   These **fractional factorial designs** are very useful in practice, especially when the number of factors is large and the number of runs is limited.

\vskip 0.15 in

-   We can think of fractional factorial designs as a type of variable importance analysis.
    -   We are trying to determine which factors are important and which factors are not important as efficiently as possible.

\vskip 0.15 in

-   Let's dive in! What would a **One-Half Fraction** look like?

## One-Half Fractional Factorial Design

-   Let's suppose we are working with a $2^3$ design.
    -   This means we have three factors, $A$, $B$, and $C$, each at two levels, $-$ and $+$.

\vskip 0.15 in

-   Check out our table on the next slide. Note, the $I$ column is the identity column and denotes the overall, grand mean of the response variable.

## One-Half Fractional Factorial Design

\begin{table}[h]
    \centering
    \caption{Full Factorial Design for a $2^3$ Experiment}
    \begin{tabular}{lcccccccc}
        \toprule
        \text{Treatment} & I & A & B & C & AB & AC & BC & ABC \\
        \midrule
        $a$ & + & + & - & - & - & - & + & + \\
        $b$ & + & - & + & - & - & + & - & + \\
        $c$ & + & - & - & + & + & - & - & + \\
        $abc$ & + & + & + & + & + & + & + & + \\
        $ab$ & + & + & + & - & + & - & - & - \\
        $ac$ & + & + & - & + & - & + & - & - \\
        $bc$ & + & - & + & + & - & - & + & - \\
        $(1)$ & + & - & - & - & + & + & + & - \\
        \bottomrule
    \end{tabular}
\end{table}

## One-Half Fractional Factorial Design

-   Suppose that instead of estimating all of the effects, we only want to estimate the main effects ($a$, $b$, and $c$) as well as the three-way interaction $abc$ as our one-half (i.e., $2^3/2 = 2^{3-1} = 4$) fraction.

\vskip 0.15 in

-   Here, we are selecting only those treatments that have a + in the $ABC$ column.

\vskip 0.15 in

-   Thus, in this case, we call $ABC$ the **generator** of this particular fraction.

## One-Half Fractional Factorial Design

-   Additionally, the identity column is always +, so we can call $I=ABC$ the **defining relation** for our design.

\vskip 0.15 in

-   In general, the defining relation for a fractional factorial will always be the set of all columns that are equal to the identity column, $I$.

\vskip 0.15 in

-   The treatment combinations of our now $2^{3-1}$ design yield three degrees of freedom to help us estimate the main effects.

## One-Half Fractional Factorial Design

-   So how do we estimate the main effect $A$ in this design? Looking in the $A$ column, we have the sequence +, -, -, + which are associated with treatments $a$, $b$, $c$, and $abc$, respectively.

\vskip 0.15 in

-   Thus, we can estimate the main effect $A$ as:

$$ [A] = \frac{1}{2}(a - b - c + abc) $$

## One-Half Fractional Factorial Design

-   Similarly, we can estimate the main effect $B$ and $C$ as:

$$ [B] = \frac{1}{2}(-a + b - c + abc) $$ $$ [C] = \frac{1}{2}(-a - b + c + abc) $$

-   Note, we use the $[A]$, $[B]$, $[C]$ notation to indicate the linear combinations (i.e., the formulas derived from the +/- table) associated with the main effects.

## One-Half Fractional Factorial Design

-   We can also define the two-way interactions as:

$$ [AB] = \frac{1}{2}(- a - b + c + abc) $$ $$ [AC] = \frac{1}{2}(- a + b - c + abc) $$ $$ [BC] = \frac{1}{2}(a - b - c + abc) $$

## One-Half Fractional Factorial Design

-   Note that, interestingly: $[A] = [BC]$, $[B] = [AC]$, and $[C] = [AB]$.
    -   What does this mean??

\vskip 0.15 in

-   This means that the main effects are **aliased** with the two-way interactions.
    -   In other words, we cannot differentiate between the main effects and the two-way interactions.

\vskip 0.15 in

-   In fact, when we estimate $A$, $B$, and $C$, we are really estimating $A + BC$, $B + AC$, and $C + AB$, respectively.

## One-Half Fractional Factorial Design

-   The alias structure can be determined by using the defining relation, $I=ABC$.

\vskip 0.15 in

-   Multiplying any column by the defining relation will yield the alias of that column.
    -   For example, to determine the alias of $A$, we can multiply the $A$ column by the defining relation, $I=ABC$:

$$ A \cdot I = A \cdot ABC = A^2 \cdot BC $$

-   If we square any column, the + remain + and the - become +. This implies that the square of any column is equal to the identity column, $I$.

## One-Half Fractional Factorial Design

-   Thus: $A^2 \cdot BC = I \cdot BC = BC$.
    -   This means that $A$ is aliased with $BC$.

\vskip 0.15 in

-   Similarly, we can find the aliases of $B$ and $C$ as:

$$ B \cdot I = B \cdot ABC = B^2 \cdot AC = I \cdot AC = AC $$ $$ C \cdot I = C \cdot ABC = C^2 \cdot AB = I \cdot AB = AB $$

## One-Half Fractional Factorial Design

-   In this last example, we chose $I=+ABC$ as our defining relation (we call this the **principal fraction**).
    -   What if we chose the other one-half fraction? That is, the treatment combinations in the +/- table associated with the -'s of the $ABC$ column?

\vskip 0.15 in

-   Here, we our defining relation would be $I=-ABC$ and our treatment combinations would be:

$$ [A]' = \frac{1}{2}(ab + ac - bc - (1)) \rightarrow A - BC $$ $$ [B]' = \frac{1}{2}(ab-ac+bc-(1)) \rightarrow B - AC $$ $$ [C]' = \frac{1}{2}(-ab+ac+bc-(1)) \rightarrow C - AB $$

## One-Half Fractional Factorial Design

-   In this case, we can see that the main effects are aliased with the two-way interactions, but they are different than the previous example.
    -   In this case, we have $A$ aliased with $-BC$, $B$ aliased with $-AC$, and $C$ aliased with $-AB$.

\vskip 0.15 in

-   This means that we are estimating $A - BC$, $B - AC$, and $C - AB$.

\vskip 0.15 in

-   So how can we de-alias our main effect estimates?

## One-Half Fractional Factorial Design

-   The answer is to run a second experiment with the opposite sign of the defining relation.
    -   For example, if we run the first experiment with $I=+ABC$, then we can run a second experiment with $I=-ABC$. When we run a second design with the intention of de-aliasing the first design, we call the full experiment a **fold-over design**.

\vskip 0.15 in

-   If we average the effects $[A]$ and $[A]'$, this implies:

$$ \frac{1}{2}([A] + [A]') = \frac{1}{2}(A + BC + A - BC) = \frac{1}{2}(2A) = A $$

-   And:

$$ \frac{1}{2}([A] - [A]') = \frac{1}{2}(A + BC - A + BC) = \frac{1}{2}(2BC) = BC $$

## One-Half Fractional Factorial Design

-   Thus, for all three pairs of linear combinations, we would obtain the following:

\begin{table}[h]
    \centering
    \begin{tabular}{ccc}
        \toprule
        $i$ & $0.5([i] + [i]')$ & $0.5([i] - [i]')$ \\
        \midrule
        $A$ & $A$ & $BC$ \\
        $B$ & $B$ & $AC$ \\
        $C$ & $C$ & $AB$ \\
        \bottomrule
    \end{tabular}
\end{table}

## One-Half Fractional Factorial Design: Design Resolution

-   The resolution of a fractional factorial design is a measure of how well the design can separate the main effects from the two-way interactions.
    -   The resolution is defined as the minimum number of factors that are aliased with each other.

\vskip 0.15 in

-   For example, a design with resolution III means that the main effects are aliased with two-way interactions, but not with each other.
    -   The $2^{3-1}$ design we've been working with is of resolution III.

\vskip 0.15 in

-   A resolution IV design means that the main effects are not aliased with each other \textit{or} with any two-way interactions. Two-way interactions may be aliased with each other.
    -   A $2^{4-1}$ design with $I=ABCD$ is a resolution IV design.

## One-Half Fractional Factorial Design: Design Resolution

-   Finally, a design with resolution V means that the main effects are not aliased with each other or with any two-way interactions, and two-way interactions are not aliased with each other. But two-way interactions may be aliased with three-way interactions.
    -   A $2^{5-1}$ design with $I=ABCDE$ is a resolution V design.

## Analysis of a One-Half Fractional Factorial Design

-   Okay so you may be asking yourself, "Self, this is all well and good but how do I use this in a practical sense?"

\vskip 0.15 in

-   Well, let's take a look at an example!

## Analysis of a One-Half Fractional Factorial Design

-   Suppose we are designing a new adventure video game about a heroic dog named Buster. We want to assess how different game design choices affect **player engagement time** (measured as the amount of time, in minutes, players actively engage with a 20-minute game demo.).

\vskip 0.15 in

-   Below represents our design table for our factors of interest:

| Factor | Description     | Low Level (–) | High Level (+)   |
|--------|-----------------|---------------|------------------|
| A      | Game Difficulty | Easy          | Hard             |
| B      | Visual Style    | Cartoon-style | Realistic        |
| C      | Narrative Depth | Lighthearted  | Emotional / Deep |

## Analysis of a One-Half Fractional Factorial Design

-   Since it can be time consuming and expensive to create full video games with all combinations of these factors, we will use a $2^3$ one-half fractional factorial design to run this experiment. The number of runs will be 4 with two replications each (8 total observations).

\vskip 0.15 in

-   As before, let's use $I=ABC$ as our defining relation. This means we will run the following treatment combinations:

| Run | A   | B   | C = AB | Description                       |
|-----|-----|-----|--------|-----------------------------------|
| 1   | –   | –   | \+     | Easy, Cartoon-style, Emotional    |
| 2   | –   | \+  | –      | Easy, Realistic, Lighthearted     |
| 3   | \+  | –   | –      | Hard, Cartoon-style, Lighthearted |
| 4   | \+  | \+  | \+     | Hard, Realistic, Emotional        |

## Analysis of a One-Half Fractional Factorial Design

-   Note, we could automatically generate this table using the `FrF2` function within the library of the same name:

\scriptsize

```{r}
library(FrF2)
design <- FrF2(4, #Number of total runs
               3, #Number of factors
               generators = "AB", #Since C=AB when I=ABC
               randomize=F)
print(design)
```

\normalsize

## Analysis of a One-Half Fractional Factorial Design

-   Remember, because of the defining relation, $I=ABC$, the following aliasing occurs:
    -   A = BC
    -   B = AC
    -   C = AB

\vskip 0.15 in

-   To reiterate, this means that our main effects are **confounded** with the two-factor interactions.

## Analysis of a One-Half Fractional Factorial Design

-   Alright, so now that the overall design is set up, let's look at some data (contained in the `Hero Buster Game.xlsx` file):

\scriptsize

```{r}
library(tidyverse)
library(readxl)
## Read in Data ##
buster <- read_excel("Hero Buster Game.xlsx")
buster |>
  glimpse()
```

\normalsize

## Analysis of a One-Half Fractional Factorial Design

-   Let's add the effect columns to our data set.
    -   We will use the formulas we derived earlier to calculate the main effects.

\scriptsize

```{r}
buster <- buster |>
  mutate(Effect = rep(c("c","b","a","abc"),
                      each=2)
         )
buster |>
  glimpse()
```

\normalsize

## Analysis of a One-Half Fractional Factorial Design

-   Now, let's calculate some summary statistics, just as we have done before!

```{r}
library(rstatix)
## Game Difficulty ##
buster |>
  group_by(Difficulty) |>
  get_summary_stats(Engagement,type="mean_sd") |>
  select(-variable)
```

## Analysis of a One-Half Fractional Factorial Design

```{r}
## Visual Style ##
buster |>
  group_by(Style) |>
  get_summary_stats(Engagement,type="mean_sd") |>
  select(-variable)
```

## Analysis of a One-Half Fractional Factorial Design

```{r}
## Narrative Depth ##
buster |>
  group_by(Narrative) |>
  get_summary_stats(Engagement,type="mean_sd") |>
  select(-variable)
```

## Analysis of a One-Half Fractional Factorial Design

-   So from what we see here, we can see that:
    1.  The Easy game difficulty has a slightly lesser mean engagement time than the Hard game difficulty, but it may not necessarily be a meaningful difference.
    2.  For the Visual Style, we see that while they Realistic style games have a slightly greater mean engagement style.
    3.  Finally, we observe the Emotional style games have a greater mean engagement time than the lighthearted style games.

\vskip 0.15 in

-   Are these meaningful from a statistical or practical perspective? Let's take a look!

## Analysis of a One-Half Fractional Factorial Design

```{r}
## Fit Model ##
mod <- aov(Engagement ~ Difficulty + Style + Narrative,
           data = buster)
```

## Analysis of a One-Half Fractional Factorial Design

-   Checking assumptions:

```{r}
library(broom)
## Shaprio-Wilk Test of Normality ##
mod |>
  resid() |>
  shapiro.test() |>
  tidy()
```

## Analysis of a One-Half Fractional Factorial Design

```{r,eval=F}
buster |>
  ggplot(aes(sample=resid(mod))) +
  geom_qq() +
  geom_qq_line() +
  theme_classic()
```

## Analysis of a One-Half Fractional Factorial Design

```{r,echo=F}
buster |>
  ggplot(aes(sample=resid(mod))) +
  geom_qq() +
  geom_qq_line() +
  theme_classic()
```

## Analysis of a One-Half Fractional Factorial Design

-   Normality looks good! What about constant variance?

```{r}
## B-P Test ##
library(lmtest)
mod |>
  bptest() |>
  tidy()
```

## Analysis of a One-Half Fractional Factorial Design

```{r,eval=F}
buster |>
  ggplot(aes(x=fitted(mod),y=rstandard(mod))) +
  geom_point() +
  geom_hline(yintercept=0,linetype="dashed") +
  geom_hline(yintercept=3,color='blue') +
  geom_hline(yintercept=-3,color='blue') +
  theme_classic()
```

## Analysis of a One-Half Fractional Factorial Design

```{r,echo=F}
buster |>
  ggplot(aes(x=fitted(mod),y=rstandard(mod))) +
  geom_point() +
  geom_hline(yintercept=0,linetype="dashed") +
  geom_hline(yintercept=3,color='blue') +
  geom_hline(yintercept=-3,color='blue') +
  theme_classic()
```

## Analysis of a One-Half Fractional Factorial Design

-   The Breush-Pagan test tells us that the model residuals may not have equality of variance.

\vskip 0.15 in

-   We can somewhat see this in the residual plot as well.

\vskip 0.15 in

-   However, given our small sample size, we can proceed but should be cautious about our conclusions.
    -   Replications of the whole experiment may be needed to confirm our results.

## Analysis of a One-Half Fractional Factorial Design

-   Now let's look at the overall results!

```{r}
mod |>
  tidy()
```

## Analysis of a One-Half Fractional Factorial Design

-   Nothing is statistically significant!!
    -   This is not surprising given our small sample size. We'll calculate partial $\eta^2$ in a bit.

\vskip 0.15 in

-   Let's now tabulate our main effects. First, let's add the effect name as a column in our dataframe:

## Analysis of a One-Half Fractional Factorial Design

```{r}
buster <- buster |>
  mutate(Effect = rep(c("c","a","b","abc"),
                      each=2))
```

## Analysis of a One-Half Fractional Factorial Design

```{r}
## Calculating the Main Effects ##
library(tidyr)
buster |>
  group_by(Effect) |>
  summarise(Engagement = mean(Engagement)) |>
  pivot_wider(names_from = Effect,
              values_from = Engagement) |>
  mutate(A = 0.5*(a-b-c+abc),
        B = 0.5*(-a+b-c+abc),
        C = 0.5*(-a-b+c+abc),
        .keep='unused' #keeps only created columns
  )
```

## Analysis of a One-Half Fractional Factorial Design

-   Cool! So what does this mean?
    -   Exactly the same interpretation as our interpretation of the means!!

\vskip 0.15 in

1.  As difficulty goes from the - level of Easy to the + level of hard, we expect an increase of 2.48 minutes.
2.  As visual style goes from the - level of Cartoon to the + level of Realistic, we expect an increase of 1.48 minutes.
3.  As narrative depth goes from the - level of Lighthearted to the + level of Emotional, we expect an increase of 1.43 minutes.

## Analysis of a One-Half Fractional Factorial Design

-   Remember, we aren't able to distinguish between the main effects and the two-way interactions.
    -   So, we need to be careful about our conclusions.

\vskip 0.15 in

-   If we were to run a second experiment with the opposite sign of the defining relation ($I=-ABC$), we could de-alias our main effects and two-way interactions.
    -   This would allow us to estimate the main effects and two-way interactions separately.

## Analysis of a One-Half Fractional Factorial Design

-   So lastly, let's calculate the partial $\eta^2$ for our main effects.
    -   This will help us determine how much of the variance in the response variable is explained by each of the main effects.

```{r}
mod |>
  partial_eta_squared()
```

## Analysis of a One-Half Fractional Factorial Design

-   This is telling us that the main effects of Difficulty, Style, and Narrative are accounting for 62.07%, 36.76%, and 35.17% of the variance in the response variable, respectively.
    -   This is a pretty good amount of variance explained for a small sample size.

\vskip 0.15 in

-   All of these effects would be considered large.
    -   This is a good example of ensuring that we don't solely rely on p-values to determine the importance of our factors.

## Final Thoughts

-   So, in summary, we have learned about one-half fractional factorial designs and how to analyze them.
    -   We have also learned about the alias structure of these designs and how to de-alias the main effects and two-way interactions using fold-over designs.

\vskip 0.15 in

-   We also learned that we have to be careful about our conclusions and not to solely rely on p-values as the measure of variable importance.

\vskip 0.15 in

-   If we wanted to go a step further, we could take a one-quarter fractional factorial design, which would allow us to estimate the main effects and two-way interactions separately.
    -   This would be a more efficient design, but it would require more runs.
