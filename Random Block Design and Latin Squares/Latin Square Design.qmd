---
title: "Latin Square Design"
author: "Dr Austin R Brown"
institute: "Kennesaw State University"
format:
  beamer:
    include-in-header:
      - text: |
          \usepackage{tabularx}
editor: visual
execute:
  echo: true
  include: true
  warning: false
  message: false
  tidy: false
---

## Introduction

-   So far, we've learned about completely randomized designs and randomized block designs.

\vskip 0.10 in

-   In CRD, we assumed we had one treatment factor and we randomly assigned treatments to experimental units.
    -   No nuisance or blocking factors.

\vskip 0.10 in

-   In RBD, we said okay there may be one nuisance factor that we can control for.
    -   We blocked the experimental units based on this factor.

\vskip 0.10 in

-   But in some cases, we may have more than one nuisance factor.
    -   Suppose we have two, for instance. What do we do then?

## Example: Comparing Dog Toy Durability

-   Let's reconsider the dog toy durability experiment we had worked on previously. Let's suppose we have three different machines which can make one of three different rubber formulations for our dog toys (say, F1, F2, and F3). The rubber formulation is our main treatment factor, but we would also want to control for any variation attributable to differences in machine. So machine will serve as a blocking factor.

\vskip 0.10 in

-   However, these machines require someone to operate them. Let's say we also have three operators trained to operate our machines. It would also be important to control for variation attributable to differences in operator as well. So we would want this to be a second blocking factor.

## Example: Comparing Dog Toy Durability

-   So to recap, we will be using a hydraulic press to measure the PSI of our dog toys when the toy rips. We are interested in comparing the mean PSI across the three rubber formulations controlling for the machine and operator.

## Study Design

-   The type of design we will use to account for **two blocking factors**, both Machine and Operator, is called a ***Latin Square Design***.
    -   Note, unlike RBD, the number of levels of the treatment and blocking factors must be equal to produce the "Square" of "Latin Square"

## Study Design

-   Our overall research question will largely stay the same from the CRD study: "Is there evidence for a difference in mean breaking PSI between the rubber formulations controlling for machine and operator effects?"

\vskip 0.10 in

-   We will have 3 treatments (F1, F2, and F3), 3 levels for our first block (Machine), and 3 levels for our second block (Operator).
    -   This is called a $3\times 3$ Latin Square.

\vskip 0.10 in

-   Each level of each blocking factor will receive each treatment exactly once.
    -   This is the key feature of a Latin Square Design.

## Study Design

-   It is sometimes helpful to visualize the design of a Latin Square. Here is a visual representation of the design we will use for our study:

\begin{table}
    \centering
     \begin{tabular}{l|ccc} 
        \toprule
        & \multicolumn{3}{c}{\textbf{Operator}} \\ 
        \cmidrule(lr){2-4} 
        \textbf{Machine} & \textbf{Op 1} & \textbf{Op 2} & \textbf{Op 3}  \\
        \midrule
        \textbf{1} & F1 & F2 & F3 \\
        \textbf{2} & F2 & F3 & F1 \\
        \textbf{3} & F3 & F1 & F2 \\
        \bottomrule
    \end{tabular}
\end{table}

## Study Design

-   Note, in a LSD, the number of replicates per square is one. So for a $3\times 3$ design, we have a total of 9 observations.
    -   This is partly why LSD is considered an efficient design. We can control sources of variability and make our treatment comparison with very few observations.

\vskip 0.10 in

-   The data are contained in the `Latin Square Dog Toys.xlsx` file.

## Descriptive Analysis

-   As before, we can begin with our descriptive analysis, starting with the calculation of the means and standard deviations of the formulations:

\scriptsize

```{r,eval=F}
library(tidyverse)
library(readxl)
## Read in Data ##
dog_toys <- read_excel("Latin Square Dog Toys.xlsx")
## Summary Statistics ##
library(rstatix)
dog_toys |>
  group_by(Formulation) |>
  get_summary_stats(PSI, type = "mean_sd")
```

\normalsize

## Descriptive Analysis

```{r,echo=F}
library(tidyverse)
library(readxl)
## Read in Data ##
dog_toys <- read_excel("Latin Square Dog Toys.xlsx")
## Summary Statistics ##
library(rstatix)
dog_toys |>
  group_by(Formulation) |>
  get_summary_stats(PSI, type = "mean_sd")
```

## Descriptive Analysis

-   It looks like Formulation 3 provides the greatest durability compared to the other two formulations.

\vskip 0.10 in

-   Now, we can visualize this information with a boxplot as before.

\vskip 0.10 in

-   Note, I'm going to just look at boxplots of the formulations rather than partition them into subgroups based on operator and machine.

\vskip 0.10 in

-   The reason for this is that we only have one observation per combination of treatment and blocking effects which makes a boxplot not terribly informative.

## Descriptive Analysis

\scriptsize

```{r,eval=F}
## Generate a Boxplot of Formulations ##
dog_toys |>
  ggplot(aes(x = Formulation, y = PSI)) +
  geom_boxplot() +
  labs(title = "Breaking PSI of Different Rubber Formulations",
       subtitle = "Dog Toy Durability Test") +
  theme_classic()
```

\normalsize

## Descriptive Analysis

```{r,echo=F}
## Generate a Boxplot of Formulations ##
dog_toys |>
  ggplot(aes(x = Formulation, y = PSI)) +
  geom_boxplot() +
  labs(title = "Breaking PSI of Different Rubber Formulations",
       subtitle = "Dog Toy Durability Test") +
  theme_classic()
```

## Descriptive Analysis

-   As shown here, we have very clear separation between Formulation 3 and the other two.

\vskip 0.10 in

-   In general, it seems like we have very low amounts of within group variation. But since none of the boxes overlap at all, this may indicate that all three formulations' breaking PSI differ substantially.

\vskip 0.10 in

-   Let's put this to the test by using our F-test. But what does this look like for a LSD?

## Inferential Analysis: Latin Square Design Model

-   For a $t\times t$ LSD, our model is:

$$ y_{ijk} = \mu + \alpha_i + \tau_j + \beta_k + \varepsilon_{ijk} $$

-   Here, $\mu$ still denotes the overall mean, $\alpha_i$ is the $i$th effect of the first blocking variable, $\tau_j$ is the $j$th treatment effect, $\beta_k$ is the $k$th effect of the second blocking variable, and $\varepsilon_{ijk}$ is the random error term as before.

## Inferential Analysis: Latin Square Design Model

-   Recall from the lecture on RBD that the Fundamental ANOVA Identity tells us that total variation, as measured by SSTotal, can be partitioned into Explained Variation and Unexplained Variation.

\vskip 0.10 in

-   In LSD, that means:

$$ SSTotal = SSTreat + SSBlock_1 + SSBlock_2 + SSE $$

## Inferential Analysis: Latin Square Design Model

\begin{table}[h]
    \centering
    \begin{tabularx}{\textwidth}{lcccc}
        \toprule
        \textbf{Source} & \textbf{df} & \textbf{SS} & \textbf{MS} & \textbf{F-Statistic}  \\
        \midrule
        Treatments & $t - 1$ & SS\textsubscript{Treatment} & $\frac{\text{SS\textsubscript{Treat}}}{t-1}$ & $\text{MS\textsubscript{Treat}}/\text{MS\textsubscript{Error}}$  \\
        \text{Block 1} & $t - 1$ & SSBlock\textsubscript{1} &  $\frac{\text{SSBlock\textsubscript{1}}}{t-1}$ & $\text{MS\textsubscript{B1}}/\text{MS\textsubscript{Error}}$ \\
        \text{Block 2}    & $t - 1$ & SSBlock\textsubscript{2} & $\frac{\text{SSBlock\textsubscript{2}}}{t-1}$ & $\text{MS\textsubscript{B2}}/\text{MS\textsubscript{Error}}$ \\
        Error & $(t - 1)(t - 2)$ & SS\textsubscript{Error} & $\frac{\text{SS\textsubscript{Error}}}{df\textsubscript{Error}}$ & -  \\
        \hline
Total      & $t^2 - 1$ & SS\textsubscript{Total} & - & -  \\
        \bottomrule
    \end{tabularx}
\end{table}

## Inferential Analysis: Latin Square Design Model

-   Recall from RBD, we only care about the hypothesis test for our treatment effect:

$$ H_0: \mu_1 = \mu_2 = \dots = \mu_t $$ $$ H_1: \text{At least two group means differ} $$

-   If $F_{stat} = MS_{Treat}/MSE > F_{CV}$ for some given value of $\alpha$, then this indicates that the data more strongly support the alternative hypothesis.

\vskip 0.10 in

-   After we've fit the model using the `aov` function and checked our assumptions of normality and constant variance, we can go ahead and perform our omnibus F-test as befre:

## Inferential Analysis: Latin Square Design Model

```{r}
## Fit Model ##
dog_mod <- aov(PSI ~ Machine + Operator + Formulation, 
               data = dog_toys)
## Perform F-Test ##
library(broom)
dog_mod |>
  tidy()
```

## Inferential Analysis: Latin Square Design Model

-   As we can see, the p-value associated with the treatment effect, `Formulation`, is 0.008.

\vskip 0.10 in

-   This indicates that the data more strongly support the alternative hypothesis, indicating that at least two of our formulations may have significantly differing mean breaking PSI values.

\vskip 0.10 in

-   To determine which two, we can use Tukey's HSD post hoc test as before.

## Inferential Analysis: Post Hoc Test

```{r}
TukeyHSD(dog_mod) |>
  tidy() |>
  select(contrast,estimate,adj.p.value)
```

## Inferential Analysis: Post Hoc Test

-   Focusing our attention on just the Formulation contrasts, we see that F3 is significantly different from F1 and F2, controlling for operator and machine effects.

\vskip 0.10 in

-   F1 and F2 are not significantly different from each other at the 0.05 level

\vskip 0.10 in

-   Contextually, if we were making the choice between the three formulations based on durability, we should probably go with Formulation 3.

## Final Thoughts

-   The LSD is an efficient design for controlling two nuisance factors.
    -   We can extend this to three blocking factors in the ***Greco-Latin Square Design***.

\vskip 0.10 in

-   However, it does have some limitations. First, like RBD, we assume no interaction between the blocks and the treatment effect. This may not always be reasonable.

\vskip 0.10 in

-   Second, the "Square" of "Latin Square" restricts the number of levels of our treatment and blocking effects.

## Final Thoughts

-   Finally, while we can increase the number of replicates through multiple runs of the same experiments, we then have to account for this in a Greco-Latin Square type of design as the run of the experiment can be considered another block.

\vskip 0.10 in

-   So in short, while LSD has some nice features, it also has disadvantages.

\vskip 0.10 in

-   We will talk about alternatives as the semester progresses.